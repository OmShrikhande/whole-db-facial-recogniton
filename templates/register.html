<!doctype html>
<title>Person Verification - Upload</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; margin: 2rem }
  .box { max-width:600px; margin:auto }
  .list { margin-top: 1rem; }
  .msg { color: #b00 }
</style>
<div class="box">
  <h1>Upload Known Person Image</h1>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul class=msg>
      {% for m in messages %}
        <li>{{ m }}</li>
      {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <form id="uploadForm" method=post enctype=multipart/form-data action="{{ url_for('upload') }}">
    <label>Person name (short):</label><br>
    <input type="text" name="name" id="nameInput" required><br><br>
    <label>Image file (jpg/png):</label><br>
    <input type="file" name="file" id="imageInput" accept="image/*" required><br>
    <div id="checkMsg" class="msg"></div>
    <br>
    <button id="uploadBtn" type="submit" disabled>Upload & Encode</button>
  </form>

  <div class="list">
    <h3>Known people</h3>
    {% if names %}
      <ul>
      {% for n in names %}
        <li>{{ n }}</li>
      {% endfor %}
      </ul>
    {% else %}
      <p><em>No known people yet.</em></p>
    {% endif %}
  </div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const checkMsg = document.getElementById('checkMsg');
    const nameInput = document.getElementById('nameInput');

    async function checkDuplicate(file) {
      const fd = new FormData();
      fd.append('image', file);
      try {
const res = await fetch("{{ url_for('check_duplicate') }}", { method: 'POST', body: fd });
        const data = await res.json();
        if (data.status === 'no_face') {
          checkMsg.textContent = 'No face detected in the image.';
          uploadBtn.disabled = true;
        } else if (data.status === 'multiple_faces') {
          checkMsg.textContent = 'Multiple faces detected in the image.';
          uploadBtn.disabled = true;
        } else if (data.duplicate) {
          checkMsg.textContent = `Duplicate detected: matched ${data.matches.join(', ')} (distance=${data.best_distance.toFixed(3)})`;
          uploadBtn.disabled = true;
        } else {
          checkMsg.textContent = 'Unique image â€” ready to upload.';
          uploadBtn.disabled = !nameInput.value.trim();
        }
      } catch (err) {
        checkMsg.textContent = 'Error checking image.';
        uploadBtn.disabled = true;
      }
    }

    imageInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      checkMsg.textContent = 'Checking image...';
      uploadBtn.disabled = true;
      checkDuplicate(f);
    });

    nameInput.addEventListener('input', () => {
      if (checkMsg.textContent.includes('Unique image')) {
        uploadBtn.disabled = !nameInput.value.trim();
      }
    });
  </script>
</div>
